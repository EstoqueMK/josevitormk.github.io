<html><head><base href="https://websim.example.com/factory-stock-manager/"><title>Gerenciador de Estoque da Fábrica</title><style>
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f7fa;
  color: #333;
}
.app-container {
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 250px;
  background-color: #2c3e50;
  color: white;
  padding: 20px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}
.main-title {
  color: #ecf0f1;
  font-size: 1.5em;
  margin-bottom: 20px;
  text-align: center;
  padding: 10px;
  background-color: #34495e;
  border-radius: 5px;
}
.main-content {
  flex-grow: 1;
  padding: 30px;
  overflow-y: auto;
}
h1, h2 {
  margin-bottom: 20px;
  color: #2c3e50;
}
.menu-item {
  padding: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 5px;
  margin-bottom: 10px;
  background-color: #34495e;
  color: #ecf0f1;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.menu-item:hover {
  background-color: #2c3e50;
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}
.stock-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 25px;
}
.stock-item, .producao-item {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.stock-item:hover, .producao-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}
.add-item-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.add-item-btn:hover {
  background-color: #2980b9;
  transform: scale(1.1);
}
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 30px;
  border: none;
  width: 80%;
  max-width: 600px;
  border-radius: 10px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
}
.close:hover,
.close:focus {
  color: #2c3e50;
}
form {
  display: flex;
  flex-direction: column;
}
input, select {
  margin-bottom: 15px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
}
button[type="submit"] {
  background-color: #3498db;
  color: white;
  border: none;
  padding: 12px;
  cursor: pointer;
  border-radius: 5px;
  font-size: 16px;
  transition: background-color 0.3s ease;
}
button[type="submit"]:hover {
  background-color: #2980b9;
}
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 10px;
  margin-top: 20px;
}
th, td {
  padding: 12px;
  text-align: left;
  background-color: white;
}
th {
  background-color: #f2f2f2;
  font-weight: bold;
}
tr {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
tr:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}
input[type="number"] {
  width: 100%;
  box-sizing: border-box;
}
.tab-content {
  display: none;
  animation: fadeIn 0.5s ease;
}
.filters {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}
.filter-item {
  display: flex;
  flex-direction: column;
}
.filter-item label {
  margin-bottom: 5px;
}
.filters select {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
  flex-grow: 1;
}
.loja-info {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.loja-info:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}
.custom-select {
  position: relative;
  margin-bottom: 15px;
}
.custom-select input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
}
.custom-select ul {
  position: absolute;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  list-style-type: none;
  padding: 0;
  margin: 0;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 5px 5px;
  background-color: white;
  display: none;
  z-index: 1;
}
.custom-select ul li {
  padding: 10px;
  cursor: pointer;
}
.custom-select ul li:hover {
  background-color: #f0f0f0;
}
.chart-container {
  width: 100%;
  height: 400px;
  margin-bottom: 20px;
}
.pie-chart-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 30px;
}
#estoqueChart {
  max-width: 500px;
  max-height: 500px;
}
#totalEstoque {
  margin-top: 20px;
  font-size: 24px;
  font-weight: bold;
}
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}
#lojasTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
#lojasTable th, #lojasTable td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: left;
}
#lojasTable th {
  background-color: #f2f2f2;
  font-weight: bold;
}
#lojasTable tr:nth-child(even) {
  background-color: #f9f9f9;
}
#lojasTable tr:hover {
  background-color: #f5f5f5;
}
#lojasTable select {
  width: 100%;
  padding: 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: white;
}
#lojasTable td {
  padding: 10px;
  border: 1px solid #ddd;
}
.delete-pedido {
  background-color: #e74c3c;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.delete-pedido:hover {
  background-color: #c0392b;
}
</style><script src="https://cdn.jsdelivr.net/npm/chart.js"></script></head><body>
<div class="app-container">
  <div class="sidebar">
    <h1 class="main-title">Controle de Estoque MK</h1>
    <h2>Gerenciador de Estoque</h2>
    <nav>
      <div class="menu-item" data-tab="dashboard">Dashboard</div>
      <div class="menu-item" data-tab="pedidos">Pedidos</div>
      <div class="menu-item" data-tab="producao">Produção/Entrada</div>
      <div class="menu-item" data-tab="historicoPedidos">Histórico Pedidos</div>
      <div class="menu-item" data-tab="previsao">Previsão</div>
      <div class="menu-item" data-tab="lojas">Lojas</div>
      <div class="menu-item" data-tab="relatorios">Relatórios</div>
    </nav>
  </div>
  <div class="main-content">
    <div id="dashboard" class="tab-content">
      <h1>Dashboard</h1>
      <div class="dashboard-grid"></div>
      <div class="pie-chart-container">
        <canvas id="estoqueChart"></canvas>
        <div id="totalEstoque"></div>
      </div>
    </div>
    <div id="pedidos" class="tab-content">
      <h1>Pedidos</h1>
      <div class="filters">
        <select id="filtroUnidade">
          <option value="">Todas as Unidades</option>
        </select>
        <select id="filtroRegiao">
          <option value="">Todas as Regiões</option>
        </select>
      </div>
      <div class="summary">
        <p>Total de Pedidos: 0</p>
        <p>Unidades: </p>
        <p>Regiões: </p>
        <p>Lojas: </p>
        <h2>Total de Produtos por Loja:</h2>
      </div>
    </div>
    <div id="producao" class="tab-content">
      <h1>Produção/Entrada</h1>
      <div class="filters">
        <div class="filter-item">
          <label for="filtroDataInicio">Data Início:</label>
          <input type="date" id="filtroDataInicio">
        </div>
        <div class="filter-item">
          <label for="filtroDataFim">Data Fim:</label>
          <input type="date" id="filtroDataFim">
        </div>
        <div class="filter-item">
          <label for="filtroUnidadeProducao">Unidade:</label>
          <select id="filtroUnidadeProducao">
            <option value="">Todas as Unidades</option>
            <option value="Capitão Gourmet">Capitão Gourmet</option>
            <option value="Brasília">Brasília</option>
            <option value="Recife">Recife</option>
            <option value="Maria Fruta">Maria Fruta</option>
            <option value="WIW">WIW</option>
          </select>
        </div>
      </div>
      <div id="producaoContent"></div>
    </div>
    <div id="historicoPedidos" class="tab-content">
      <h1>Histórico Pedidos</h1>
      <div class="stock-grid" id="pedidosGrid">
      </div>
    </div>
    <div id="previsao" class="tab-content">
      <h1>Previsão</h1>
      <div class="filters">
        <select id="filtroLoja">
          <option value="">Todas as Lojas</option>
        </select>
      </div>
      <div id="previsaoContent"></div>
    </div>
    <div id="lojas" class="tab-content">
      <h1>Lojas</h1>
      <div class="custom-select">
        <input type="text" id="lojaSearchFilter" placeholder="Pesquisar loja...">
        <ul id="lojaOptionsFilter"></ul>
      </div>
      <table id="lojasTable">
        <thead>
          <tr>
            <th>Nome da Loja</th>
            <th>Dia da Expedição</th>
          </tr>
        </thead>
        <tbody>
          <!-- Table content will be dynamically added here -->
        </tbody>
      </table>
    </div>
    <div id="relatorios" class="tab-content">
      <h1>Relatórios</h1>
      <p>Selecione o tipo de relatório que deseja gerar:</p>
      <select id="tipoRelatorio">
        <option value="">Selecione um tipo de relatório</option>
        <option value="estoque">Relatório de Estoque</option>
        <option value="pedidos">Relatório de Pedidos</option>
        <option value="producao">Relatório de Produção</option>
      </select>
      <div id="relatorioContent"></div>
    </div>
  </div>
</div>

<button class="add-item-btn" id="addItemBtn">+</button>

<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Nova Adição</h2>
    <form id="addItemForm">
      <select id="tipoEntrada">
        <option value="">Selecione o Tipo</option>
        <option value="Produção/Entrada">Produção/Entrada</option>
        <option value="Pedidos">Pedidos</option>
      </select>
      <div id="pedidosFields" style="display: none;">
        <div class="custom-select">
          <input type="text" id="lojaSearch" placeholder="Pesquisar loja...">
          <ul id="lojaOptions"></ul>
        </div>
        <select id="unidade">
          <option value="">Unidade</option>
        </select>
        <select id="regiao">
          <option value="">Região</option>
        </select>
        <select id="diaExpedicao" style="display: none;">
          <option value="">Dia da Expedição</option>
          <option value="Segunda">Segunda</option>
          <option value="Terça">Terça</option>
          <option value="Quarta">Quarta</option>
          <option value="Quinta">Quinta</option>
          <option value="Sexta">Sexta</option>
        </select>
      </div>
      <input type="date" id="data">
      <table id="productTable">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Frango</td><td><input type="number" name="quantidade" id="firstQuantityInput" min="0"></td></tr>
          <tr><td>Português</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Calabresa</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Margherita</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Brócolis</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Maxi Beef</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Peito de Peru</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Frango Catupiry</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Quatro Queijos</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Vegano</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Filet Mignon com Cheddar</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Kalzone com Galak</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Calabresa Catupiry</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Chocolate</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Frango, Cheddar e Bacon</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Camarão Catupiry</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Frango & Palmito</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Kalzone com Nutella</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Carne Seca Especial</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Tá ligado (polpinha)</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Sem Noção</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Irado</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Daora</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Tá Ligado (1 kg)</td><td><input type="number" name="quantidade" min="0"></td></tr>
        </tbody>
      </table>
      <button type="submit">Adicionar</button>
    </form>
  </div>
</div>

<script>
let stockItems = [];
let currentStock = {
  "Capitão Gourmet": {},
  "Brasília": {},
  "Recife": {},
  "Maria Fruta": {},
  "WIW": {}
};
let expedicaoDays = {};

const regioesPorUnidade = {
  "Capitão Gourmet": ["Grande Florianópolis", "Rota SC", "Rota Norte SC", "Rota Sul SC+RS", "Rota SP+PR+MA+MS"],
  "Brasília": ["Rota Centro-Oeste"],
  "Recife": ["Rota Nordeste"],
  "Maria Fruta": ["Maria Fruta"],
  "WIW": ["WIW"]
};

const lojasPorRegiao = {
  "Grande Florianópolis": [
    "UFSC", "Anita", "Felipe Schimidt", "Kobrasol", "Itaguaçu", "Via Catarina",
    "Capitão Gourmet", "Trindade", "Lagoa", "Floripa Shopping", "Imbituba",
    "Beira Mar", "Mk Coqueiros", "Continente Shopping", "Angeloni Capoeiras",
    "Angeloni Beira Mar", "Forquilhas", "Jardim Cidade", "Palhoça", "Estreito",
    "Pinheira", "Deodoro", "Ingleses", "Garopaba", "Rio Tavares", "Barreiros",
    "Praia Comprida", "Guarda Do Embaú", "Pedra Branca", "Tijucas", "Laguna",
    "Villa Romana", "Campeche", "Biguaçu", "Santo Amaro", "Campo Duna"
  ],
  "Rota SC": [
    "Concórdia", "Chapecó", "Joaçaba", "Braço Do Norte", "Rio Do Sul"
  ],
  "Rota Norte SC": [
    "Blumenau Neumarkt", "Blumenau Park Shopping", "Mueller Joinville", "Garten Joinville",
    "Blumenau Norte Shopping", "Balneário Shopping", "Jaraguá Do Sul Park Shopping", "Itajaí",
    "Joinville Guanabara", "Balneário Camelódromo", "São Francisco Do Sul", "Meia Praia Itapema",
    "Joinville Centro", "Jaraguá Centro", "Avenida Atlântica Balneário Rua", "Brusque", "Itajaí Rua",
    "Garcia Blumenau Rua", "Camboriú Rua", "Komprão Itapema", "Unisociesc"
  ],
  "Rota Sul SC+RS": [
    "Tubarão SC", "Shopping Total Porto Alegre", "Canoas RS", "Bourbon Shopping Caxias", 
    "Shopping do Vale Cachoeirinha", "Criciúma SC", "Pelotas Shopping", "Gravataí RS", "Lages SC", 
    "Cachoeirinha Rua", "Araranguá", "Criciúma Nações", "Iguatemi POA", "São Leopoldo", "Novo Hamburgo",
    "Canoas Park", "Villagio Caxias", "Barra Shop. POA", "Passo Fundo", "PUC",
    "Pelotas Centro Andrade Neves", "Tubarão Drive", "Vacaria", "Lages Rua", "Nh Outlet",
    "Oasis", "Pelotas Drive Avenida Bento Gonçalves", "Cachoeira Do Sul", "POA Galeria Chaves", "Praia De Belas"
  ],
  "Rota SP+PR+MA+MS": [
    "Curitiba PR", "Estação Curitiba PR", "Barueri SP", "Campo Grande MS",
    "Bauru SP", "Cascavel PR", "Guarapuava", "Ponta Grossa PR",
    "Shopping Da Ilha MA", "Rio Anil MA", "BH MG", "Contagem MG"
  ],
  "Rota Centro-Oeste": [
    "Taguatinga DF", "Bramk Pátio Brasil DF", "Conjunto Nacional DF", "Anashoping",
    "Anápolis GO", "Valparaíso GO", "Alameda DF", "Jk DF", "Aparecida De Goiania",
    "Park Shopping", "Recanto", "Carrefour GO", "Águas Claras DF", "Águas Lindas"
  ],
  "Rota Nordeste": [
    "Tacaruna", "Boa Vista", "Guararapes", "Mangabeira", "Maceió", "Manaíra", "Recife"
  ],
  "Maria Fruta": ["Maria Fruta"],
  "WIW": ["WIW"]
};

const allLojas = Object.values(lojasPorRegiao).flat();

function saveDataToLocalStorage() {
  localStorage.setItem('stockItems', JSON.stringify(stockItems));
  localStorage.setItem('currentStock', JSON.stringify(currentStock));
  localStorage.setItem('expedicaoDays', JSON.stringify(expedicaoDays));
}

function loadDataFromLocalStorage() {
  const savedStockItems = localStorage.getItem('stockItems');
  const savedCurrentStock = localStorage.getItem('currentStock');
  const savedExpedicaoDays = localStorage.getItem('expedicaoDays');

  if (savedStockItems) {
    stockItems = JSON.parse(savedStockItems);
  }
  if (savedCurrentStock) {
    currentStock = JSON.parse(savedCurrentStock);
  }
  if (savedExpedicaoDays) {
    expedicaoDays = JSON.parse(savedExpedicaoDays);
  } else {
    expedicaoDays = {}; // Initialize as an empty object if not found in localStorage
  }
}

function migrateLojaNames() {
  const oldToNewNames = {
    "Blumenau Rua": "Garcia Blumenau Rua",
    "Cachoeirinha RS": "Shopping do Vale Cachoeirinha",
    "Balneário Rua": "Avenida Atlântica Balneário Rua"
  };

  // Update expedicaoDays
  for (const [oldName, newName] of Object.entries(oldToNewNames)) {
    if (expedicaoDays[oldName]) {
      expedicaoDays[newName] = expedicaoDays[oldName];
      delete expedicaoDays[oldName];
    }
  }

  // Update stockItems
  stockItems.forEach(item => {
    if (item.loja && oldToNewNames[item.loja]) {
      item.loja = oldToNewNames[item.loja];
    }
  });

  saveDataToLocalStorage();
}

function calculateAveragePedidos() {
  const pedidosPorLoja = {};

  stockItems.forEach(item => {
    if (item.isPedido) {
      if (!pedidosPorLoja[item.loja]) {
        pedidosPorLoja[item.loja] = [];
      }
      pedidosPorLoja[item.loja].push(item.produtos);
    }
  });

  const averagePedidos = {};

  for (const [loja, pedidos] of Object.entries(pedidosPorLoja)) {
    averagePedidos[loja] = {};
    const totalPedidos = pedidos.length;

    pedidos.forEach(pedido => {
      for (const [produto, quantidade] of Object.entries(pedido)) {
        if (!averagePedidos[loja][produto]) {
          averagePedidos[loja][produto] = 0;
        }
        averagePedidos[loja][produto] += quantidade;
      }
    });

    for (const [produto, total] of Object.entries(averagePedidos[loja])) {
      averagePedidos[loja][produto] = Math.round(total / totalPedidos);
    }
  }

  return averagePedidos;
}

function applyFilters() {
  const selectedUnidade = document.getElementById('filtroUnidade').value;
  const selectedRegiao = document.getElementById('filtroRegiao').value;
  const lojaInfoDivs = document.querySelectorAll('.loja-info');

  lojaInfoDivs.forEach(div => {
    const unidade = div.dataset.unidade;
    const regiao = div.dataset.regiao;
    const showUnidade = !selectedUnidade || unidade === selectedUnidade;
    const showRegiao = !selectedRegiao || regiao === selectedRegiao;
    
    if (showUnidade && showRegiao) {
      div.style.display = 'block';
    } else {
      div.style.display = 'none';
    }
  });
}

function updateStock(item) {
  const unit = item.unidade || "Capitão Gourmet"; // Default to Capitão Gourmet if no unit specified
  for (const [produto, quantidade] of Object.entries(item.produtos)) {
    if (!currentStock[unit][produto]) {
      currentStock[unit][produto] = 0;
    }
    if (item.tipoEntrada === 'Produção/Entrada') {
      currentStock[unit][produto] += quantidade;
    } else if (item.tipoEntrada === 'Pedidos') {
      currentStock[unit][produto] -= quantidade;
    }
  }
  saveDataToLocalStorage(); // Add this line
}

function deletePedido(index) {
  const deletedItem = stockItems[index];
  stockItems.splice(index, 1);
  
  // Reverse the stock update for the deleted pedido
  if (deletedItem.isPedido) {
    const unit = deletedItem.unidade || "Capitão Gourmet";
    for (const [produto, quantidade] of Object.entries(deletedItem.produtos)) {
      if (currentStock[unit][produto]) {
        currentStock[unit][produto] += quantidade; // Add back to stock
      }
    }
  }
  
  saveDataToLocalStorage();
  renderStockItems();
}

function calculatePredictedStock() {
  const predictedStock = {};
  const averageConsumption = {};
  const idealStock = {};

  for (const [unit, stock] of Object.entries(currentStock)) {
    averageConsumption[unit] = {};
    idealStock[unit] = {};
    for (const [product, quantity] of Object.entries(stock)) {
      averageConsumption[unit][product] = Math.round(quantity * 0.1);
      idealStock[unit][product] = quantity + averageConsumption[unit][product];
    }
  }

  for (const [unit, stock] of Object.entries(currentStock)) {
    predictedStock[unit] = {};
    for (const [product, quantity] of Object.entries(stock)) {
      predictedStock[unit][product] = idealStock[unit][product] - quantity;
    }
  }

  return predictedStock;
}

function updateDashboardChart() {
  const dashboardGrid = document.querySelector('.dashboard-grid');
  dashboardGrid.innerHTML = ''; // Clear existing content

  // Create a chart for each unit
  for (const [unit, stock] of Object.entries(currentStock)) {
    const chartContainer = document.createElement('div');
    chartContainer.className = 'chart-container';
    dashboardGrid.appendChild(chartContainer);

    const canvas = document.createElement('canvas');
    chartContainer.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    
    const labels = Object.keys(stock);
    const data = Object.values(stock);

    // Calculate ideal stock levels (this is a simplified example)
    const idealStock = data.map(value => value * 1.2); // 20% more than current stock

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Current Stock',
            data: data,
            backgroundColor: data.map(value => {
              if (value < 10) return 'red';
              if (value > 50) return 'orange';
              return 'rgba(75, 192, 192, 0.6)';
            }),
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          },
          {
            label: 'Ideal Stock',
            data: idealStock,
            type: 'line',
            fill: false,
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          title: {
            display: true,
            text: `Stock Levels - ${unit}`,
            font: {
              size: 18
            }
          },
          legend: {
            labels: {
              font: {
                size: 14
              }
            }
          }
        }
      }
    });
  }

  // Create pie chart for total stock by unit
  const estoqueCtx = document.getElementById('estoqueChart').getContext('2d');
  const totalEstoqueElement = document.getElementById('totalEstoque');

  // Destroy existing chart if it exists
  if (window.estoqueChart instanceof Chart) {
    window.estoqueChart.destroy();
  }

  const unitColors = {
    "Capitão Gourmet": "rgba(255, 99, 132, 0.8)",
    "Brasília": "rgba(54, 162, 235, 0.8)",
    "Recife": "rgba(255, 206, 86, 0.8)",
    "Maria Fruta": "rgba(75, 192, 192, 0.8)",
    "WIW": "rgba(153, 102, 255, 0.8)"
  };

  const unitTotals = Object.entries(currentStock).map(([unit, stock]) => ({
    unit,
    total: Object.values(stock).reduce((sum, value) => sum + value, 0)
  }));

  const totalEstoque = unitTotals.reduce((sum, { total }) => sum + total, 0);

  window.estoqueChart = new Chart(estoqueCtx, {
    type: 'pie',
    data: {
      labels: unitTotals.map(({ unit }) => unit),
      datasets: [{
        data: unitTotals.map(({ total }) => total),
        backgroundColor: unitTotals.map(({ unit }) => unitColors[unit]),
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
        title: {
          display: true,
          text: 'Total Estoque por Unidade',
          font: {
            size: 18
          }
        }
      }
    }
  });

  totalEstoqueElement.innerHTML = `<h2>Total Estoque: ${totalEstoque}</h2>`;
}

function renderPrevisaoTab() {
  const previsaoTab = document.getElementById('previsao');
  const averagePedidos = calculateAveragePedidos();

  let previsaoHTML = '<h1>Previsão</h1>';
  
  previsaoHTML += `
    <div class="filters">
      <select id="filtroLoja">
        <option value="">Todas as Lojas</option>
        ${Object.keys(averagePedidos).map(loja => `<option value="${loja}">${loja}</option>`).join('')}
      </select>
    </div>
  `;

  previsaoHTML += '<div id="previsaoContent"></div>';

  previsaoTab.innerHTML = previsaoHTML;

  document.getElementById('filtroLoja').addEventListener('change', updatePrevisaoDisplay);

  updatePrevisaoDisplay();
}

function updatePrevisaoDisplay() {
  const previsaoContent = document.getElementById('previsaoContent');
  const selectedLoja = document.getElementById('filtroLoja').value;
  const averagePedidos = calculateAveragePedidos();

  let filteredPedidos = selectedLoja ? { [selectedLoja]: averagePedidos[selectedLoja] } : averagePedidos;

  let previsaoHTML = '';

  for (const [loja, produtos] of Object.entries(filteredPedidos)) {
    previsaoHTML += `<h2>${loja}</h2>`;
    previsaoHTML += '<table><thead><tr><th>Produto</th><th>Quantidade Média</th></tr></thead><tbody>';
    
    for (const [produto, quantidade] of Object.entries(produtos)) {
      previsaoHTML += `<tr><td>${produto}</td><td>${quantidade}</td></tr>`;
    }
    
    previsaoHTML += '</tbody></table>';
  }

  previsaoContent.innerHTML = previsaoHTML;
}

function renderStockItems() {
  const pedidosGrid = document.getElementById('pedidosGrid');
  if (pedidosGrid) {
    pedidosGrid.innerHTML = '';
  }
  
  const summary = {
    totalPedidos: 0,
    totalProdutosPorLoja: {},
    unidades: new Set(),
    regioes: new Set(),
    lojas: new Set(),
    lojaInfo: {}
  };
  
  stockItems.forEach((item, index) => {
    const stockItemElement = document.createElement('div');
    stockItemElement.className = 'stock-item';
    stockItemElement.innerHTML = `
      <h3>${item.unidade}</h3>
      <p>Região: ${item.regiao}</p>
      <p>Loja: ${item.loja || 'N/A'}</p>
      <p>Data: ${item.data}</p>
      <p>Dia da Expedição: ${item.diaExpedicao || 'N/A'}</p>
      <p>Tipo: ${item.tipoEntrada}</p>
      <ul>
        ${Object.entries(item.produtos).map(([produto, quantidade]) => 
          `<li>${produto}: ${quantidade}</li>`
        ).join('')}
      </ul>
      ${item.isPedido ? `<button class="delete-pedido" data-index="${index}">Excluir Pedido</button>` : ''}
    `;
    if (item.isPedido && pedidosGrid) {
      pedidosGrid.appendChild(stockItemElement);
      
      summary.totalPedidos++;
      summary.unidades.add(item.unidade);
      summary.regioes.add(item.regiao);
      summary.lojas.add(item.loja);
      
      summary.lojaInfo[item.loja] = {
        unidade: item.unidade,
        regiao: item.regiao
      };

      if (!summary.totalProdutosPorLoja[item.loja]) {
        summary.totalProdutosPorLoja[item.loja] = {};
      }
      
      Object.entries(item.produtos).forEach(([produto, quantidade]) => {
        summary.totalProdutosPorLoja[item.loja][produto] = (summary.totalProdutosPorLoja[item.loja][produto] || 0) + quantidade;
      });
    }
  });
  
  const pedidosTab = document.getElementById('pedidos');
  if (pedidosTab) {
    let produtosHTML = '';
    
    const filtroUnidade = document.getElementById('filtroUnidade');
    const filtroRegiao = document.getElementById('filtroRegiao');
    
    filtroUnidade.innerHTML = '<option value="">Todas as Unidades</option>';
    filtroRegiao.innerHTML = '<option value="">Todas as Regiões</option>';
    
    Array.from(summary.unidades).forEach(unidade => {
      filtroUnidade.innerHTML += `<option value="${unidade}">${unidade}</option>`;
    });
    
    Array.from(summary.regioes).forEach(regiao => {
      filtroRegiao.innerHTML += `<option value="${regiao}">${regiao}</option>`;
    });

    produtosHTML += '<h2>Total de Produtos por Loja:</h2>';
    for (const [loja, produtos] of Object.entries(summary.totalProdutosPorLoja)) {
      const lojaInfo = summary.lojaInfo[loja] || { unidade: 'N/A', regiao: 'N/A' };
      produtosHTML += `
        <div class="loja-info" data-unidade="${lojaInfo.unidade}" data-regiao="${lojaInfo.regiao}">
          <h3>${loja}</h3>
          <p>Unidade: ${lojaInfo.unidade}, Região: ${lojaInfo.regiao}</p>
          <ul>
            ${Object.entries(produtos).map(([produto, quantidade]) => 
              `<li>${produto}: ${quantidade}</li>`
            ).join('')}
          </ul>
        </div>
      `;
    }
    
    pedidosTab.innerHTML = `
      <h1>Pedidos</h1>
      <div class="filters">
        <select id="filtroUnidade">
          <option value="">Todas as Unidades</option>
          ${Array.from(summary.unidades).map(unidade => `<option value="${unidade}">${unidade}</option>`).join('')}
        </select>
        <select id="filtroRegiao">
          <option value="">Todas as Regiões</option>
          ${Array.from(summary.regioes).map(regiao => `<option value="${regiao}">${regiao}</option>`).join('')}
        </select>
      </div>
      <div class="summary">
        <p>Total de Pedidos: ${summary.totalPedidos}</p>
        <p>Unidades: ${Array.from(summary.unidades).join(', ')}</p>
        <p>Regiões: ${Array.from(summary.regioes).join(', ')}</p>
        <p>Lojas: ${Array.from(summary.lojas).join(', ')}</p>
        ${produtosHTML}
      </div>
    `;

    document.getElementById('filtroUnidade').addEventListener('change', applyFilters);
    document.getElementById('filtroRegiao').addEventListener('change', applyFilters);
  }

  const productionItems = stockItems.filter(item => item.tipoEntrada === 'Produção/Entrada');
  renderProducaoEntradaTab(productionItems);
  updateDashboardChart(); 
  
  // Add event listeners for delete buttons
  const deleteButtons = document.querySelectorAll('.delete-pedido');
  deleteButtons.forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      deletePedido(index);
    });
  });
}

function renderLojasTab() {
  const lojasTableBody = document.querySelector('#lojasTable tbody');
  lojasTableBody.innerHTML = '';
  
  allLojas.sort().forEach(loja => {
    const row = document.createElement('tr');
    
    // Loja name cell
    const nameCell = document.createElement('td');
    nameCell.textContent = loja;
    row.appendChild(nameCell);
    
    // Dia da Expedição cell
    const expedicaoCell = document.createElement('td');
    const expedicaoSelect = document.createElement('select');
    expedicaoSelect.innerHTML = `
      <option value="">Selecione o dia</option>
      <option value="Segunda">Segunda</option>
      <option value="Terça">Terça</option>
      <option value="Quarta">Quarta</option>
      <option value="Quinta">Quinta</option>
      <option value="Sexta">Sexta</option>
    `;
    expedicaoSelect.value = expedicaoDays[loja] || ''; // Set the saved value
    expedicaoSelect.addEventListener('change', function() {
      saveExpedicaoDay(loja, this.value);
    });
    expedicaoCell.appendChild(expedicaoSelect);
    row.appendChild(expedicaoCell);
    
    lojasTableBody.appendChild(row);
  });

  // Populate the searchable dropdown
  populateLojaOptionsFilter(allLojas);

  // Add event listener for the search input
  const lojaSearchFilter = document.getElementById('lojaSearchFilter');
  lojaSearchFilter.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filteredLojas = allLojas.filter(loja => 
      loja.toLowerCase().includes(searchTerm)
    );
    populateLojaOptions(filteredLojas);
    document.getElementById('lojaOptionsFilter').style.display = 'block';
    filterLojasTable(searchTerm);
  });

  lojaSearchFilter.addEventListener('focus', () => {
    document.getElementById('lojaOptionsFilter').style.display = 'block';
  });

  document.addEventListener('click', (e) => {
    if (!lojaSearchFilter.contains(e.target) && !document.getElementById('lojaOptionsFilter').contains(e.target)) {
      document.getElementById('lojaOptionsFilter').style.display = 'none';
    }
  });
}

function saveExpedicaoDay(loja, day) {
  expedicaoDays[loja] = day;
  saveDataToLocalStorage(); // This will save the data immediately
}

function renderProducaoEntradaTab(productionItems) {
  const producaoTab = document.getElementById('producao');
  if (producaoTab) {
    let producaoHTML = '<h1>Produção/Entrada</h1>';
    
    // Add filters
    producaoHTML += '<div class="filters">';
    producaoHTML += `
      <div class="filter-item">
        <label for="filtroDataInicio">Data Início:</label>
        <input type="date" id="filtroDataInicio">
      </div>
    `;
    producaoHTML += `
      <div class="filter-item">
        <label for="filtroDataFim">Data Fim:</label>
        <input type="date" id="filtroDataFim">
      </div>
    `;
    producaoHTML += `
      <div class="filter-item">
        <label for="filtroUnidadeProducao">Unidade:</label>
        <select id="filtroUnidadeProducao">
          <option value="">Todas as Unidades</option>
          <option value="Capitão Gourmet">Capitão Gourmet</option>
          <option value="Brasília">Brasília</option>
          <option value="Recife">Recife</option>
          <option value="Maria Fruta">Maria Fruta</option>
          <option value="WIW">WIW</option>
        </select>
      </div>
    `;
    producaoHTML += '</div>';

    producaoHTML += '<div id="producaoContent"></div>';

    producaoTab.innerHTML = producaoHTML;

    // Add event listeners for filters
    document.getElementById('filtroDataInicio').addEventListener('change', updateProducaoDisplay);
    document.getElementById('filtroDataFim').addEventListener('change', updateProducaoDisplay);
    document.getElementById('filtroUnidadeProducao').addEventListener('change', updateProducaoDisplay);

    updateProducaoDisplay();
  }
}

function updateProducaoDisplay() {
  const producaoContent = document.getElementById('producaoContent');
  const dataInicio = document.getElementById('filtroDataInicio').value;
  const dataFim = document.getElementById('filtroDataFim').value;
  const unidade = document.getElementById('filtroUnidadeProducao').value;
  
  let filteredItems = stockItems.filter(item => item.tipoEntrada === 'Produção/Entrada');
  
  if (dataInicio) {
    filteredItems = filteredItems.filter(item => item.data >= dataInicio);
  }
  if (dataFim) {
    filteredItems = filteredItems.filter(item => item.data <= dataFim);
  }
  if (unidade) {
    filteredItems = filteredItems.filter(item => item.unidade === unidade);
  }
  
  const groupedByDate = {};
  filteredItems.forEach(item => {
    if (!groupedByDate[item.data]) {
      groupedByDate[item.data] = [];
    }
    groupedByDate[item.data].push(item);
  });

  const sortedDates = Object.keys(groupedByDate).sort();

  let producaoHTML = '';
  sortedDates.forEach(date => {
    producaoHTML += `<h2>${date}</h2>`;
    groupedByDate[date].forEach(item => {
      producaoHTML += `
        <div class="producao-item">
          <h3>${item.unidade || 'Produção/Entrada'}</h3>
          <ul>
            ${Object.entries(item.produtos).map(([produto, quantidade]) => 
              `<li>${produto}: ${quantidade}</li>`
            ).join('')}
          </ul>
        </div>
      `;
    });
  });

  producaoContent.innerHTML = producaoHTML;
}

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.style.display = 'none';
  });
  document.getElementById(tabName).style.display = 'block';

  if (tabName === 'previsao') {
    renderPrevisaoTab();
  } else if (tabName === 'relatorios') {
    renderRelatoriosTab();
  }
}

// Add the new functions here
function renderRelatoriosTab() {
  const relatoriosTab = document.getElementById('relatorios');
  if (relatoriosTab) {
    let relatoriosHTML = `
      <h1>Relatórios</h1>
      <p>Selecione o tipo de relatório que deseja gerar:</p>
      <select id="tipoRelatorio">
        <option value="">Selecione um tipo de relatório</option>
        <option value="estoque">Relatório de Estoque</option>
        <option value="pedidos">Relatório de Pedidos</option>
        <option value="producao">Relatório de Produção</option>
      </select>
      <div id="relatorioContent"></div>
    `;
    
    relatoriosTab.innerHTML = relatoriosHTML;

    const tipoRelatorioSelect = document.getElementById('tipoRelatorio');
    const relatorioContent = document.getElementById('relatorioContent');

    tipoRelatorioSelect.addEventListener('change', function() {
      const selectedReport = this.value;
      
      switch(selectedReport) {
        case 'estoque':
          relatorioContent.innerHTML = generateEstoqueReport();
          break;
        case 'pedidos':
          relatorioContent.innerHTML = generatePedidosReport();
          break;
        case 'producao':
          relatorioContent.innerHTML = generateProducaoReport();
          break;
        default:
          relatorioContent.innerHTML = '';
      }
    });

    // Automatically select and generate the Estoque report
    tipoRelatorioSelect.value = 'estoque';
    relatorioContent.innerHTML = generateEstoqueReport();
  }
}

function generateEstoqueReport() {
  let report = '<h2>Relatório de Estoque</h2>';
  let totalEstoque = 0;
  let lowStockItems = [];
  let overStockItems = [];

  for (const [unit, stock] of Object.entries(currentStock)) {
    report += `<h3>${unit}</h3>`;
    report += '<table><thead><tr><th>Produto</th><th>Quantidade em Estoque</th><th>Estoque Ideal</th><th>Status</th></tr></thead><tbody>';
    
    for (const [produto, quantidade] of Object.entries(stock)) {
      const estoqueIdeal = Math.ceil(quantidade * 1.2);
      totalEstoque += quantidade;
      let status;
      
      if (quantidade < estoqueIdeal * 0.8) {
        status = '<span style="color: red;">Baixo</span>';
        lowStockItems.push({ unit, produto, quantidade, estoqueIdeal });
      } else if (quantidade > estoqueIdeal * 1.2) {
        status = '<span style="color: orange;">Excesso</span>';
        overStockItems.push({ unit, produto, quantidade, estoqueIdeal });
      } else {
        status = '<span style="color: green;">Adequado</span>';
      }
      
      report += `<tr><td>${produto}</td><td>${quantidade}</td><td>${estoqueIdeal}</td><td>${status}</td></tr>`;
    }
    report += '</tbody></table>';
  }

  report += `<h3>Resumo do Estoque</h3>`;
  report += `<p>Estoque Total: ${totalEstoque} unidades</p>`;
  
  if (lowStockItems.length > 0) {
    report += `<h4>Itens com Estoque Baixo</h4>`;
    report += '<ul>';
    lowStockItems.forEach(item => {
      report += `<li>${item.unit} - ${item.produto}: ${item.quantidade} (Ideal: ${item.estoqueIdeal})</li>`;
    });
    report += '</ul>';
  }

  if (overStockItems.length > 0) {
    report += `<h4>Itens com Estoque em Excesso</h4>`;
    report += '<ul>';
    overStockItems.forEach(item => {
      report += `<li>${item.unit} - ${item.produto}: ${item.quantidade} (Ideal: ${item.estoqueIdeal})</li>`;
    });
    report += '</ul>';
  }

  return report;
}

function generatePedidosReport() {
  let report = '<h2>Relatório de Pedidos</h2>';
  const pedidos = stockItems.filter(item => item.isPedido);
  report += `<p>Total de Pedidos: ${pedidos.length}</p>`;
  report += '<table><thead><tr><th>Loja</th><th>Data</th><th>Produtos</th></tr></thead><tbody>';
  pedidos.forEach(pedido => {
    report += `<tr><td>${pedido.loja}</td><td>${pedido.data}</td><td>`;
    for (const [produto, quantidade] of Object.entries(pedido.produtos)) {
      report += `${produto}: ${quantidade}<br>`;
    }
    report += '</td></tr>';
  });
  report += '</tbody></table>';
  return report;
}

function generateProducaoReport() {
  let report = '<h2>Relatório de Produção</h2>';
  const producaoItems = stockItems.filter(item => item.tipoEntrada === 'Produção/Entrada');
  report += `<p>Total de Entradas: ${producaoItems.length}</p>`;
  report += '<table><thead><tr><th>Unidade</th><th>Data</th><th>Produtos</th></tr></thead><tbody>';
  producaoItems.forEach(item => {
    report += `<tr><td>${item.unidade}</td><td>${item.data}</td><td>`;
    for (const [produto, quantidade] of Object.entries(item.produtos)) {
      report += `${produto}: ${quantidade}<br>`;
    }
    report += '</td></tr>';
  });
  report += '</tbody></table>';
  return report;
}

const modal = document.getElementById('addItemModal');
const btn = document.getElementById('addItemBtn');
const span = document.getElementsByClassName('close')[0];
const unidadeSelect = document.getElementById('unidade');
const regiaoSelect = document.getElementById('regiao');
const tipoEntradaSelect = document.getElementById('tipoEntrada');
const pedidosFields = document.getElementById('pedidosFields');
const lojaSearch = document.getElementById('lojaSearch');
const lojaOptions = document.getElementById('lojaOptions');
let currentLojas = [];

btn.onclick = function() {
  modal.style.display = "block";
}

span.onclick = function() {
  modal.style.display = "none";
}

window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

tipoEntradaSelect.addEventListener('change', function() {
  if (this.value === 'Pedidos') {
    pedidosFields.style.display = 'block';
    document.getElementById('productTable').style.display = 'table';
    document.querySelector('.custom-select').style.display = 'block';
    unidadeSelect.style.display = 'block';
    regiaoSelect.style.display = 'block';
    document.getElementById('diaExpedicao').style.display = 'block';
    populateLojaOptions(allLojas);
  } else if (this.value === 'Produção/Entrada') {
    pedidosFields.style.display = 'block';
    document.getElementById('productTable').style.display = 'table';
    unidadeSelect.style.display = 'block';
    regiaoSelect.style.display = 'none';
    document.querySelector('.custom-select').style.display = 'none';
    document.getElementById('diaExpedicao').style.display = 'none';
    populateUnidadeOptions();
  } else {
    pedidosFields.style.display = 'none';
    document.getElementById('productTable').style.display = 'none';
    document.getElementById('diaExpedicao').style.display = 'none';
  }
});

function populateUnidadeOptions() {
  unidadeSelect.innerHTML = '<option value="">Selecione a Unidade</option>';
  Object.keys(regioesPorUnidade).forEach(unidade => {
    unidadeSelect.innerHTML += `<option value="${unidade}">${unidade}</option>`;
  });
}

function populateLojaOptions(lojas) {
  lojaOptions.innerHTML = '';
  lojas.forEach(loja => {
    const li = document.createElement('li');
    li.textContent = loja;
    li.addEventListener('click', () => {
      lojaSearch.value = loja;
      lojaOptions.style.display = 'none';
      autoFillUnidadeRegiao(loja);
    });
    lojaOptions.appendChild(li);
  });
}

function populateLojaOptionsFilter(lojas) {
  const lojaOptionsFilter = document.getElementById('lojaOptionsFilter');
  lojaOptionsFilter.innerHTML = '';
  lojas.forEach(loja => {
    const li = document.createElement('li');
    li.textContent = loja;
    li.addEventListener('click', () => {
      document.getElementById('lojaSearchFilter').value = loja;
      lojaOptionsFilter.style.display = 'none';
      filterLojasTable(loja);
    });
    lojaOptionsFilter.appendChild(li);
  });
}

function filterLojasTable(searchTerm) {
  const rows = document.querySelectorAll('#lojasTable tbody tr');
  rows.forEach(row => {
    const lojaName = row.querySelector('td:first-child').textContent;
    if (lojaName.toLowerCase().includes(searchTerm.toLowerCase())) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function autoFillUnidadeRegiao(selectedLoja) {
  for (const [unidade, regioes] of Object.entries(regioesPorUnidade)) {
    for (const regiao of regioes) {
      if (lojasPorRegiao[regiao] && lojasPorRegiao[regiao].includes(selectedLoja)) {
        unidadeSelect.innerHTML = Object.keys(regioesPorUnidade).map(u => `<option value="${u}">${u}</option>`).join('');
        unidadeSelect.value = unidade;
        
        regiaoSelect.innerHTML = regioes.map(r => `<option value="${r}">${r}</option>`).join('');
        regiaoSelect.value = regiao;
        
        // Set Dia da Expedição if available
        if (expedicaoDays[selectedLoja]) {
          document.getElementById('diaExpedicao').value = expedicaoDays[selectedLoja];
        }
        
        return;
      }
    }
  }
}

lojaSearch.addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const filteredLojas = allLojas.filter(loja => 
    loja.toLowerCase().includes(searchTerm)
  );
  populateLojaOptions(filteredLojas);
  lojaOptions.style.display = 'block';
});

lojaSearch.addEventListener('focus', () => {
  lojaOptions.style.display = 'block';
});

document.addEventListener('click', (e) => {
  if (!lojaSearch.contains(e.target) && !lojaOptions.contains(e.target)) {
    lojaOptions.style.display = 'none';
  }
});

document.getElementById('addItemForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const newItem = {
    tipoEntrada: document.getElementById('tipoEntrada').value,
    data: document.getElementById('data').value,
    produtos: {},
    isPedido: document.getElementById('tipoEntrada').value === 'Pedidos'
  };

  if (newItem.isPedido) {
    newItem.loja = lojaSearch.value;
    newItem.unidade = unidadeSelect.value;
    newItem.regiao = regiaoSelect.value;
    newItem.diaExpedicao = document.getElementById('diaExpedicao').value;
  } else if (newItem.tipoEntrada === 'Produção/Entrada') {
    newItem.unidade = unidadeSelect.value;
  }

  const quantidadeInputs = document.querySelectorAll('#productTable input[name="quantidade"]');
  const produtoNames = document.querySelectorAll('#productTable td:first-child');

  quantidadeInputs.forEach((input, index) => {
    const quantidade = parseInt(input.value) || 0;
    if (quantidade > 0) {
      newItem.produtos[produtoNames[index].textContent] = quantidade;
    }
  });

  if (Object.values(newItem).some(value => value !== '' && value !== null && value !== undefined) || Object.keys(newItem.produtos).length > 0) {
    stockItems.push(newItem);
    updateStock(newItem);  
    renderStockItems();
    modal.style.display = "none";
    this.reset();
    
    switchTab(newItem.isPedido ? 'historicoPedidos' : 'producao');
    saveDataToLocalStorage(); // Add this line
  } else {
    alert('Por favor, preencha pelo menos um campo antes de salvar.');
  }
});

document.querySelectorAll('.menu-item').forEach(item => {
  item.addEventListener('click', function() {
    switchTab(this.dataset.tab);
  });
});

// Call switchTab when the page loads to show the default tab
document.addEventListener('DOMContentLoaded', function() {
  switchTab('dashboard'); // Or whichever tab you want to show by default
});

// Load data when the page initializes
loadDataFromLocalStorage();
migrateLojaNames();
renderStockItems();
updateDashboardChart();
renderLojasTab();

function handlePaste(e) {
  e.preventDefault();
  const pastedData = e.clipboardData.getData('text');
  const rows = pastedData.split('\n');
  const quantityInputs = document.querySelectorAll('#productTable input[name="quantidade"]');
  
  rows.forEach((row, index) => {
    if (index < quantityInputs.length) {
      const value = parseInt(row.trim());
      if (!isNaN(value)) {
        quantityInputs[index].value = value;
      }
    }
  });
}

// Add paste event listeners to quantity inputs
document.querySelectorAll('#productTable input[name="quantidade"]').forEach(input => {
  input.addEventListener('paste', handlePaste);
});
</script></body></html>
